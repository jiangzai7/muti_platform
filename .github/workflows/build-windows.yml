name: Flutter Windows Build with EXE Detection

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-package:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --release

      - name: Verify EXE file exists
        id: verify_exe
        run: |
          $exePath = "build\windows\runner\Release\*.exe"
          $exeFiles = Get-ChildItem -Path $exePath -ErrorAction SilentlyContinue
          if ($exeFiles) {
            Write-Host "âœ… EXE æ–‡ä»¶æ‰¾åˆ°: $($exeFiles.FullName)"
            Write-Host "æ–‡ä»¶å¤§å°: $([math]::Round($exeFiles.Length/1MB,2)) MB"
            Write-Host "::set-output name=exe_path::$($exeFiles.FullName)"
            Write-Host "::set-output name=exe_name::$($exeFiles.Name)"
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ° EXE æ–‡ä»¶"
            Write-Host "å½“å‰ç›®å½•: $(Get-Location)"
            Write-Host "æ„å»ºç›®å½•å†…å®¹:"
            Get-ChildItem -Path "build" -Recurse | Format-Table FullName
            exit 1
          }
        shell: pwsh

      - name: List all files in release directory
        run: |
          Write-Host "=== Release ç›®å½•å®Œæ•´æ–‡ä»¶åˆ—è¡¨ ==="
          Get-ChildItem -Path "build/windows/runner/Release" -Recurse | 
            Format-Table Name, @{Name="Size(KB)";Expression={[math]::Round($_.Length/1KB,2)}}, LastWriteTime
        shell: pwsh

      - name: Upload executable
        uses: actions/upload-artifact@v4
        with:
          name: MyApp-Windows
          path: |
            build/windows/runner/Release/*.exe
            build/windows/runner/Release/*.dll
            build/windows/runner/Release/data/
          retention-days: 30

      - name: Show download instructions
        run: |
          Write-Host "ğŸ‰ æ„å»ºæˆåŠŸ!"
          Write-Host ""
          Write-Host "ğŸ“¥ ä¸‹è½½åº”ç”¨ç¨‹åº:"
          Write-Host "1. ç‚¹å‡»ä¸Šæ–¹çš„ 'Summary' æ ‡ç­¾"
          Write-Host "2. åœ¨ Artifacts éƒ¨åˆ†æ‰¾åˆ° 'MyApp-Windows'"
          Write-Host "3. ç‚¹å‡»ä¸‹è½½ ZIP æ–‡ä»¶"
          Write-Host ""
          Write-Host "ğŸ“ è§£å‹åæ‚¨å°†æ‰¾åˆ°:"
          Write-Host "   - ä¸»ç¨‹åº EXE æ–‡ä»¶"
          Write-Host "   - å¿…è¦çš„ DLL æ–‡ä»¶"
          Write-Host "   - èµ„æºæ–‡ä»¶"
        shell: pwsh
